#!/bin/bash
PLAY_ICON=''
PAUSE_ICON=''
MAX_LENGTH=50

dependencies_available() {
    [ "$(command -v spotify)" ] && [ "$(command -v playerctl)" ]
}

truncate() {
    STRING="${1}"
    echo "${STRING}" | cut -c "1-$((MAX_LENGTH-3))"
}

create_full_status() {
    ICON_STATUS="${1}"
    ARTIST="$(playerctl -p spotify metadata artist)"
    TITLE="$(playerctl -p spotify metadata title)"
    ALBUM="$(playerctl -p spotify metadata album)"
    ARTIST_TITLE_COMBINED="${ARTIST} - ${TITLE}"
    if [ ${#ARTIST_TITLE_COMBINED} -gt ${MAX_LENGTH} ]; then
        ARTIST_TITLE_COMBINED="$(truncate "${ARTIST_TITLE_COMBINED}")..."
        ARTIST_TITLE_COMBINED="${ARTIST_TITLE_COMBINED/ .../...}"
    fi
    FULL_STATUS='<tool>'
    FULL_STATUS+="ARTIST...: ${ARTIST}\n"
    FULL_STATUS+="TITLE......: ${TITLE}\n"
    FULL_STATUS+="ALBUM..: ${ALBUM}"
    FULL_STATUS+='</tool>'
    FULL_STATUS+="<txt><span fgcolor='#d3dae3'>${ICON_STATUS} ${ARTIST_TITLE_COMBINED}</span></txt>"
    FULL_STATUS="${FULL_STATUS//&/&amp;}"
    echo -e "${FULL_STATUS}"
}

if dependencies_available; then
    case "$(playerctl -p spotify status)" in
        'Playing')
            create_full_status "${PLAY_ICON}"
            ;;
        'Paused')
            create_full_status "${PAUSE_ICON}"
            ;;
        *)
            echo ''
            ;;
    esac
fi
